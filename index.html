<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width" />
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700italic,700' rel='stylesheet' type='text/css'>
  
  <title>Scratch Card</title>
  <style type="text/css">
html {
  box-sizing: border-box;
}
*, *:before, *:after {
  box-sizing: inherit;
}
.scratchpad{
  width: 350px;
  height: 250px;
  border: solid 10px #FFFFFF;
  margin:0 auto;
}
body {
    background:#efefef;
}
.scratch-container {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  width:100%;
  position:absolute;
}
#generated-numbers{
  margin-left:4%;
  margin-top:5%;
  position:absolute;
  z-index:0;
}
@media only screen and (max-width : 480px) {
  .scratchpad {width:400px;height:396px;}
  .scratch-container {width:400px !important;}
}
 
/* Custom, iPhone Retina */ 
@media only screen and (max-width : 320px) {
  .scratchpad {width:290px;height:287px;}
  .scratch-container {width:290px !important;}
}
.btn {
  background:#56CFD2;
  color:#FFF;
  padding:10px 25px;
  display:inline-block;
  margin-top:15px;
  text-decoration:none;
  font-weight:600;
  text-transform:uppercase;
  border-radius:3px;
  -moz-border-radius:3px;
  -webkit-border-radiuss:3px;
}
  </style>
 
</head>
<body>
<div>
  <div>
    <form name="myform" onsubmit="return handleClick()" style="width:100%">
      <div style="margin-left:38%">
        Enter Code:<input id="scratcher-id" type="text">
        <input type="submit">
      </div>
    </form>
  </div>
  <div class="scratch-container">
    <div id="numbers" class="scratchpad">
      <canvas id="generated-numbers" width="300" height="200" style="border:1px solid #000000;"></canvas>
    </div>
  </div>
</div>
 
 
<script src="https://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

<!-- source code for scratchpad -->
<script type="text/javascript" src="https://jennamolby.com/scratch-and-win/js/wScratchPad.min.js"></script>
 
<script type="text/javascript">
  let numberMax = 20;
  let numberScratchItems = 5;
  let weightedPrizeSplits = {
    '10000': [[1, 2, 4, 5], [40, 20, 20, 20]],
    '1500': [[1, 2, 3, 4, 5], [40, 20, 20, 10, 10]],
    '1000': [[1, 2, 4, 5], [70, 10, 10, 10]],
    '500': [[1, 2, 4, 5], [70, 10, 10, 10]],
    '200': [[1, 2, 4], [50, 30, 20]],
    '100': [[1, 2], [50, 50]]
  };
  let weightedLostPrizes = [
    [10000, 5000, 2500, 2000, 1500, 1000, 500, 350, 250, 200, 100, 50],
    [1, 1, 1, 1, 2, 2, 5, 5, 10, 20, 24, 28]
  ];

  let prizeTicketIndicators = {
    '42691': 10000,
    '13092': 1500,
    '29375': 1000,
    '17292': 500,
    '82986': 200,
    '54686': 100,
    '19873': 0
};

  let ticketPrefix = '35';
  let ticketSuffix = '26';

  var data = {
    'prizeAmount': null,
    'scratch_items': [],
    'winningNumber': null
  };

  function getWinningNumber() {
    return Math.floor(Math.random() * numberMax) + 1;
  }

  function getPrizeAmount() {
    let ticketId = $('#scratcher-id').val();
    if (ticketId.length != 17) {
      alert("Invalid ticket id");
    }
    ticketId = ticketId.substring(2, 15);
    let ticketIndicator = ticketId[0];
    for (let index = 0; index < 4; index += 1) {
      ticketId = ticketId.substring(3);
      ticketIndicator += ticketId[0];
    }
    return prizeTicketIndicators[ticketIndicator];
  }

  function pickUsingWeights(items, weights) {
    var total = 0;
    var ranges = weights.slice(0);
    for(var i = 0, len = weights.length; i < len; i++) {
      ranges[i] = [total, total += ranges[i]];
    }
    var randomNumber = parseInt(Math.random() * total);
    for(;randomNumber < ranges[--i][0];);
    return items[i];
  }

  // fisher yates shuffle
  function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function getScratchItems() {
    let items = [];
    let winningNumber = getWinningNumber();
    data['winningNumber'] = winningNumber;
    let numberFillerPrizes = numberScratchItems;
    let totalPrize = getPrizeAmount();
    if (totalPrize) {
      let prizeSplits = pickUsingWeights(weightedPrizeSplits[totalPrize.toString()][0],
                                         weightedPrizeSplits[totalPrize.toString()][1]);
      let numberSplit = prizeSplits;
      let valueSplit = Math.floor(parseInt(totalPrize, 10) / numberSplit);
      for (let index = 0; index < numberSplit; index += 1) {
        items.push([winningNumber, valueSplit]);
      }
      numberFillerPrizes = numberScratchItems - numberSplit;
    }
    if (totalPrize == null) {
      alert("Invalid ticket id");
    }
    if (numberFillerPrizes) {
      let nonWinningNumbers = [];
      for (let index = 1; index < numberMax + 1; index += 1) {
        if (index != winningNumber) {
          nonWinningNumbers.push(index);
        }
      }
      let fillerNumbers = [];
      for (let index = 0; index < numberFillerPrizes; index += 1) {
        fillerNumbers.push(nonWinningNumbers[Math.floor(Math.random() * nonWinningNumbers.length)]);
      }
      let fillerPrizes = [];
      for (let index = 0; index < numberFillerPrizes; index += 1) {
        fillerPrizes.push(pickUsingWeights(weightedLostPrizes[0], weightedLostPrizes[1]));
      }
      for (let index = 0; index < numberFillerPrizes; index += 1) {
        items.push([fillerNumbers[index], fillerPrizes[index]]);
      }
      if (numberFillerPrizes != numberScratchItems) {
        shuffle(items);
      }
    }
    return items;
  }
</script>
<script type="text/javascript">
  function handleClick() {
    $('#numbers').wScratchPad('reset');
    drawCard();
    return false;
  }

  function drawBanned(ctx, xOffsetSum, yOffsetSum) {
    ctx.save();
    ctx.translate(xOffsetSum, yOffsetSum);
    ctx.rotate(-Math.PI/6);
    ctx.font = '22px "stencil std"';
    ctx.fillStyle = 'red';
    ctx.fillText("Banned", -45, 20);
    ctx.restore();
  }
  function drawBargain(ctx, xOffsetSum, yOffsetSum) {
    ctx.save();
    ctx.translate(xOffsetSum, yOffsetSum);
    ctx.rotate(-Math.PI/6);
    ctx.font = '20px "stencil std"';
    ctx.fillStyle = 'green';
    ctx.fillText("Bargain", -45, 20);
    ctx.restore();
  }

  function drawCard() {
    var values = getScratchItems();
    var winningNumber = data['winningNumber'];

    var xOffset = 100;
    var yOffset = 40;

    var c = document.getElementById("generated-numbers");
    var ctx = c.getContext("2d");
    ctx.font = "30px Arial";
    var xOffsetSum = 40;
    var yOffsetSum = 50;
    ctx.clearRect(0, 0, c.width, c.height);
    ctx.fillText(winningNumber, xOffsetSum, yOffsetSum);
    xOffsetSum += xOffset;
    for (let index = 0; index < values.length; index += 1) {
      if (index == 2) {
        xOffsetSum = 40;
        yOffsetSum += 100;
      }
      value = values[index];
      if (value[0] != winningNumber) {
        drawBanned(ctx, xOffsetSum, yOffsetSum);
      } else {
        drawBargain(ctx, xOffsetSum, yOffsetSum);
      }
      let numberXOffset = 0;
      if (value[0] > 9) {
        numberXOffset = -3;
      }
      ctx.fillText(value[0], xOffsetSum + numberXOffset, yOffsetSum);
      let prizeXOffset;
      if (value[1] < 100) {
        prizeXOffset = -8;
        if (value[0] > 9) {
          prizeXOffset = -4;
        }
      } else if (value[1] < 1000) {
        prizeXOffset = -12;
        if (value[0] < 10) {
          prizeXOffset = -17;
        }
      } else if (value[1] < 10000) {
        prizeXOffset = -20;
        if (value[0] < 10) {
          prizeXOffset = -25;
        }
      } else {
        prizeXOffset = -25;
        if (value[0] < 10) {
          prizeXOffset = -32;
        }
      }
      ctx.fillText(value[1], xOffsetSum + prizeXOffset, yOffsetSum + yOffset);
      xOffsetSum += xOffset;
    }
  }
   
  var bg3 = '#00';
  $('#numbers').wScratchPad({
      // the size of the eraser
      size        : 30,    
      // the generated scratch image   
      bg:  bg3,
      // give real-time updates
      realtime    : true, 
      // The overlay image
      fg: 'http://u.cubeupload.com/jefeconleche/scratchtoplayer.jpg',
      // The cursor (coin) image
      'cursor': 'url("https://jennamolby.com/scratch-and-win/images/coin1.png") 5 5, default'
   });
</script>
      
 
</body>
</html>
